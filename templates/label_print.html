{% extends 'base.html' %}
{% block title %}Label — {{ case.case_code }}{% endblock %}
{% block content %}

<!-- Screen toolbar (not printed) -->
<div class="d-print-none mb-3">
  <button class="btn btn-primary" onclick="window.print()">Drucken</button>
  <a class="btn btn-outline-secondary" href="{% url 'case_detail' case.id %}">Zurück</a>
</div>

<!-- ===== SCREEN PREVIEW (unchanged) ===== -->
<div class="d-print-none">
  <div class="label-a6 border p-3">
    <div class="d-flex justify-content-between">
      <div>
        <div class="fw-bold">{{ case.case_code }}</div>
        <div>{{ case.patient_name }}</div>
        <div>Geb.: {{ case.patient_dob|date:'d.m.Y' }}</div>
        <div>Labor: {{ case.lab }}</div>
        <div class="mt-1 small">Status: {{ case.get_status_display }}</div>
      </div>
      <img alt="QR" src="{% url 'case_qr_png' case.id %}" style="width:160px;height:160px;"/>
    </div>
    <div class="small mt-2">Scannen → Status aktualisieren</div>
  </div>
</div>

<!-- ===== PRINT-ONLY: D520, PORTRAIT 50 × 80 mm ===== -->
<div id="print-label" aria-hidden="true">
  <div class="pl5080-wrap">
    <div class="pl5080-grid">
      <!-- LEFT: Content -->
      <div class="pl-left">
        <!-- Header row -->
        <div class="pl-head">
          <div class="pl-code">{{ case.case_code }}</div>
          <div class="pl-lab">Labor: {{ case.lab.name|default:case.lab }}</div>
        </div>

        <div class="pl-sep"></div>

        <!-- Patient block -->
        <div class="pl-patient">
          <div class="pl-name">{{ case.patient_name }}</div>
          <div class="pl-dob">Geburtsdatum: {{ case.patient_dob|date:'d.m.Y' }}</div>
        </div>

        <!-- Footer info -->
        <div class="pl-footer">
          <div class="pl-status">Status: {{ case.get_status_display }}</div>
          <div class="pl-hint">Bitte QR-Code scannen, um den Status zu aktualisieren.</div>
        </div>
      </div>

      <!-- RIGHT: QR block -->
      <div class="pl-qr">
        <img alt="QR" src="{% url 'case_qr_png' case.id %}">
        <div class="pl-qr-cap">SCAN</div>
      </div>
    </div>
  </div>
</div>

<style>
/* -------- PRINT PAGE: D520 portrait 80 × 50 mm (width × height) -------- */
@page { size: 80mm 50mm; margin: 0; }

@media print {
  /* Show only the print label */
  body * { visibility: hidden !important; }
  #print-label, #print-label * { visibility: visible !important; }
  #print-label { position: fixed; inset: 0; width: 80mm; height: 50mm; }
  html, body { width: 80mm; height: 50mm; margin: 0 !important; padding: 0 !important; }

  /* If your D520 has a small unprintable top margin, you can nudge the content: */
  /* .pl5080-wrap { transform: translateY(0.5mm); } */

  .navbar, .toast, .modal { display: none !important; }
}

/* Hidden on screen; visible when printing */
#print-label { display: none; }
@media print { #print-label { display: block; } }

/* -------- LAYOUT & TYPOGRAPHY for 80 × 50 (content 78 × 48) -------- */
.pl5080-wrap{
  width: 78mm;           /* inner content area */
  height: 48mm;
  margin: 1mm;           /* 1mm safe margin all sides */
  box-sizing: border-box;
  padding: 2mm;          /* inner padding inside content box */
  color: #000;           /* thermal-friendly */
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  -webkit-print-color-adjust: exact; print-color-adjust: exact;
  /* optional hairline border for alignment; comment out if not wanted */
  /* border: 0.2mm solid #000; */
}

/* Two columns: flexible text + fixed QR on the right */
.pl5080-grid{
  display: grid;
  grid-template-columns: 1fr 22mm;   /* QR column ~22mm */
  gap: 2mm;
  height: 100%;
}

/* Left column structure: head, divider, patient, spacer, footer */
.pl-left{
  display: grid;
  grid-template-rows: auto 1mm auto 1fr auto;
  min-width: 0;
  height: 100%;
}

/* Header */
.pl-head{ min-width: 0; }
.pl-code{
  font-weight: 800;
  font-size: 11pt;               /* strong & readable on 80mm height */
  letter-spacing: .2px;
  line-height: 1.1;
  text-transform: uppercase;
  overflow-wrap: anywhere; word-break: break-word;
}
.pl-lab{
  margin-top: .6mm;
  font-size: 8.5pt;
  line-height: 1.2;
  overflow-wrap: anywhere; word-break: break-word;
  color: #111;
}

/* Divider */
.pl-sep{
  height: 0.4mm;
  background: #000;
  border-radius: .25mm;
  margin: 1.4mm 0;
  opacity: .95;
}

/* Patient block */
.pl-patient{
  display: grid;
  row-gap: .8mm;
  min-width: 0;
}
.pl-name{
  font-weight: 700;
  font-size: 10pt;
  line-height: 1.2;
  overflow-wrap: anywhere; word-break: break-word;
}
.pl-dob{
  font-size: 8.5pt;
  line-height: 1.2;
  overflow-wrap: anywhere; word-break: break-word;
}

/* Footer */
.pl-footer{
  align-self: end;
  display: grid;
  row-gap: .6mm;
}
.pl-status{
  font-size: 8.5pt;
  line-height: 1.2;
  overflow-wrap: anywhere; word-break: break-word;
}
.pl-hint{
  font-size: 7.5pt;
  line-height: 1.15;
  color: #333;
  overflow-wrap: anywhere; word-break: break-word;
}

/* Right QR column */
.pl-qr{
  display: grid;
  grid-template-rows: 1fr auto;   /* QR + caption */
  align-items: center;
  justify-items: center;
  height: 100%;
}
.pl-qr img{
  width: 22mm; height: 22mm;      /* crisp, easy to scan */
  object-fit: contain;
}
.pl-qr-cap{
  margin-top: 1mm;
  font-size: 8pt;
  letter-spacing: 1px;
  font-weight: 700;
}

/* Safety: avoid overflow cutting */
.pl5080-wrap, .pl5080-grid, .pl-left, .pl-patient, .pl-footer { overflow: hidden; }
</style>

{% endblock %}
